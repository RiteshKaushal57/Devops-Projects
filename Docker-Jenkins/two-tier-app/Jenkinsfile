pipeline {
    agent any

    environment {
        FRONTEND_DIR = 'Docker-Jenkins/two-tier-app/frontend'
        BACKEND_DIR  = 'Docker-Jenkins/two-tier-app/backend'
        FRONTEND_IMAGE = 'two-tier-frontend:latest'
        BACKEND_IMAGE  = 'two-tier-backend:latest'
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'ðŸ“¥ Pulling latest code from GitHub...'
                checkout scm
            }
        }

        stage('Build Frontend') {
            steps {
                echo 'ðŸ’» Building frontend...'
                dir("${FRONTEND_DIR}") {
                    sh """
                        docker run --rm -v "\$PWD":/app -w /app node:18 bash -c "npm install && npm run build"
                        docker build -t ${FRONTEND_IMAGE} .
                    """
                }
            }
        }

        stage('Build Backend') {
            steps {
                echo 'ðŸ“¦ Building backend...'
                dir("${BACKEND_DIR}") {
                    sh """
                        docker run --rm -v "\$PWD":/app -w /app node:18 bash -c "npm install"
                        docker build -t ${BACKEND_IMAGE} .
                    """
                }
            }
        }

        stage('Run Containers') {
            steps {
                echo 'ðŸš€ Running backend container...'
                sh 'docker run -d -p 3000:3000 --name backend ${BACKEND_IMAGE} || echo "Backend container already running."'

                echo 'ðŸš€ Running frontend container...'
                sh 'docker run -d -p 8080:80 --name frontend ${FRONTEND_IMAGE} || echo "Frontend container already running."'
            }
        }
    }

    post {
        always {
            echo 'ðŸ§¹ Cleaning up old containers...'
            sh 'docker ps -aq --filter "name=frontend" | xargs -r docker rm -f || true'
            sh 'docker ps -aq --filter "name=backend" | xargs -r docker rm -f || true'
        }
    }
}
